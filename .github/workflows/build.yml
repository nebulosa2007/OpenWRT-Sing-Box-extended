permissions:
  contents: write

name: Sing-Box-extended for OpenWRT

on:
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get_tag.outputs.tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get upstream latest release tag
        id: get_tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: 'shtorm-7/sing-box-extended'
        run: |
          TAG=$(wget -qO- --header="Authorization: token $GH_TOKEN" "https://api.github.com/repos/$REPO/releases/latest" | grep -Po '"tag_name": "\K.+?(?=")')
          if [ -z "$TAG" ]; then echo "Error: Tag not found"; exit 1; fi
          echo "Latest upstream tag: $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

  build:
    needs: check
    if: ${{ needs.check.outputs.tag != 'SKIP' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        branch:
        # - openwrt-23.05
          - openwrt-24.10
        arch:
          # - aarch64_cortex-a53
          # - aarch64_cortex-a72
          # - aarch64_generic
          # - arm_arm1176jzf-s_vfp
          # - arm_arm926ej-s
          # - arm_cortex-a15_neon-vfpv4
          # - arm_cortex-a5_vfpv4
          # - arm_cortex-a7
          # - arm_cortex-a7_neon-vfpv4
          # - arm_cortex-a7_vfpv4
          # - arm_cortex-a8_vfpv3
          # - arm_cortex-a9
          # - arm_cortex-a9_neon
          # - arm_cortex-a9_vfpv3-d16
          # - arm_fa526
          # - arm_mpcore
          # - arm_xscale
          # - mips64_octeonplus
          # - mips_24kc
          # - mips_4kec
          # - mips_mips32
          - mipsel_24kc
          # - mipsel_24kc_24kf
          # - mipsel_74kc
          # - mipsel_mips32
          # - x86_64
        # exclude:
        #   - branch: openwrt-24.10
        #     arch: arm_mpcore
        # include:
        #   - branch: openwrt-24.10
        #     arch: aarch64_cortex-a76
    container:
      image: openwrt/sdk:${{ matrix.arch }}-${{ matrix.branch }}
      options: --user root
    defaults: { run: { shell: bash } }
    env:
      UPSTREAM_TAG: ${{ needs.check.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache OpenWrt build directories
        uses: actions/cache@v4
        with:
          path: |
            /builder/dl
            /builder/feeds
          key: ${{ matrix.branch }}-${{ matrix.arch }}-openwrt-cache-${{ hashFiles('**/feeds.conf.default') }}
          restore-keys: |
            ${{ matrix.branch }}-${{ matrix.arch }}-openwrt-cache-

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            /root/.cache/go-build
            /builder/staging_dir/host/pkg
          key: ${{ matrix.branch }}-${{ matrix.arch }}-go-${{ needs.check.outputs.tag }}
          restore-keys: |
            ${{ matrix.branch }}-${{ matrix.arch }}-go-cache-

      - name: Setup SDK
        working-directory: /builder
        run: |
          HOME=/builder ./setup.sh
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          ./scripts/feeds install golang

      - name: Compile package
        id: compile
        working-directory: /builder
        env:
          ARCH: ${{ matrix.arch }}
          BRANCH: ${{ matrix.branch }}
          UPSTREAM_TAG: ${{ needs.check.outputs.tag }}
        run: |
          set -euo pipefail

          echo "============================================"
          echo "Building sing-box-extended ${UPSTREAM_TAG}"
          echo "Architecture: ${ARCH}"
          echo "Branch: ${BRANCH}"
          echo "============================================"

          PKG_DIR="/builder/package/sing-box-extended"
          mkdir -p "${PKG_DIR}/files"
          wget -O "${PKG_DIR}/Makefile" "https://raw.githubusercontent.com/openwrt/packages/master/net/sing-box/Makefile"
          wget -O "${PKG_DIR}/files/sing-box.init" "https://raw.githubusercontent.com/openwrt/packages/master/net/sing-box/files/sing-box.init"
          wget -O "${PKG_DIR}/files/sing-box.conf" "https://raw.githubusercontent.com/openwrt/packages/master/net/sing-box/files/sing-box.conf"
          chmod +x "${PKG_DIR}/files/sing-box.init"

          echo "=== Adapting Makefile for sing-box-extended =="
          VERSION_CLEAN="${UPSTREAM_TAG#v}"

          sed -i 's|../../lang/golang/golang-package.mk|$(TOPDIR)/feeds/packages/lang/golang/golang-package.mk|' "${PKG_DIR}/Makefile"

          sed -i 's|Package/sing-box|Package/sing-box-extended|g' "${PKG_DIR}/Makefile"
          sed -i 's|call BuildPackage,sing-box|call BuildPackage,sing-box-extended|g' "${PKG_DIR}/Makefile"

          sed -i "s|^PKG_NAME:=.*|PKG_NAME:=sing-box-extended|" "${PKG_DIR}/Makefile"
          sed -i "s|^PKG_VERSION:=.*|PKG_VERSION:=${VERSION_CLEAN}|" "${PKG_DIR}/Makefile"
          sed -i "s|^PKG_SOURCE_URL:=.*|PKG_SOURCE_URL:=https://codeload.github.com/shtorm-7/sing-box-extended/tar.gz/\$(PKG_SOURCE_VERSION)?|" "${PKG_DIR}/Makefile"
          sed -i "s|^PKG_SOURCE_VERSION:=.*|PKG_SOURCE_VERSION:=${UPSTREAM_TAG}|" "${PKG_DIR}/Makefile"
          sed -i "s|^PKG_HASH:=.*|PKG_HASH:=skip|" "${PKG_DIR}/Makefile"
          sed -i "s|^PKG_MIRROR_HASH:=.*|PKG_MIRROR_HASH:=skip|" "${PKG_DIR}/Makefile"
          sed -i "s|^PKG_MAINTAINER:=.*|PKG_MAINTAINER:=shtorm <sergeimaklagin7@gmail.com>|" "${PKG_DIR}/Makefile"

          sed -i '/USERID:=sing-box=5566:sing-box=5566/a\  PROVIDES:=sing-box\n  CONFLICTS:=sing-box' "${PKG_DIR}/Makefile"

          sed -i '/define Package\/sing-box-extended-tiny/,/endef/ { /PROVIDES:=/d; /CONFLICTS:=/d; }' "${PKG_DIR}/Makefile"

          sed -i 's|TITLE:=.*|TITLE:=Sing-box with extended features|' "${PKG_DIR}/Makefile"
          sed -i 's|URL:=.*|URL:=https://github.com/shtorm-7/sing-box-extended|' "${PKG_DIR}/Makefile"

          sed -i 's/depends on PACKAGE_sing-box/depends on PACKAGE_sing-box-extended/g' "${PKG_DIR}/Makefile"
          sed -i 's/Package\/sing-box-extended-tiny\/description:=$(Package\/sing-box-extended\/description)/Package\/sing-box-extended-tiny\/description:=$(Package\/sing-box-extended\/description)/' "${PKG_DIR}/Makefile"

          echo "========== Modified Makefile =========="
          head -n 200 "${PKG_DIR}/Makefile"
          echo "========================================"

          echo "========= Configuring package ==========="
          make defconfig

          echo "========== Starting compilation =========="
          make package/sing-box-extended/compile V=s -j$(nproc) 2>&1 | tee build.log || (tail -n 100 build.log && exit 1)

          if [ $? -eq 0 ]; then
            echo "====== ✓ Compilation successful ========"
          else
            echo "===== ✗ Compilation failed ==========="
            exit 1
          fi

          echo "========= Creating repository index ==========="
          make package/index

          echo "========== Collecting IPK files =============="
          ARTIFACT_DIR="/builder/final_artifacts"
          mkdir -p "${ARTIFACT_DIR}"
          find bin/packages/ -name "sing-box-extended*.ipk" -exec cp -v {} "${ARTIFACT_DIR}/" \;
          find bin/packages/ -name "Packages*" -exec cp -v {} "${ARTIFACT_DIR}/" \;
          
          cd "${ARTIFACT_DIR}"
          tar -cvf "/builder/ipk-${BRANCH}-${ARCH}.tar" .
          
          echo "============================================"
          echo "✓ Build completed successfully"
          echo "Artifact: ipk-${BRANCH}-${ARCH}.tar"
          echo "============================================"
          tar -tvf "/builder/ipk-${BRANCH}-${ARCH}.tar"

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: ipk-${{ matrix.branch }}-${{ matrix.arch }}
          path: /builder/ipk-${{ matrix.branch }}-${{ matrix.arch }}.tar

  gh-pages:
    needs: [check, build]
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ipk-*
          merge-multiple: true

      - name: Prepare Repository
        run: |
          mkdir -p public
          find . -name 'ipk-*.tar' -exec tar -xvf {} -C ./public \;
          echo "<html><body><h1>Sing-box-extended Repository</h1></body></html>" > public/index.html

      - name: Deploy to GH pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          force_orphan: true

  release:
    needs: [check, build]
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1
      matrix:
        branch:
          # - openwrt-23.05
          - openwrt-24.10
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ipk-${{ matrix.branch }}-*
          merge-multiple: true

      - name: Extract for Release
        env:
          BRANCH: ${{ matrix.branch }}
        run: |
          find . -name "ipk-$BRANCH-*.tar" -exec tar -xvf {} \;
          rm -f Packages* index.html

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          fail_on_unmatched_files: true
          tag_name: ${{ needs.check.outputs.tag }}-${{ matrix.branch }}
          name: ${{ needs.check.outputs.tag }} for OpenWrt ${{ matrix.branch }}
          target_commitish: gh-pages
          body: |
            ### Sing-box-extended ${{ needs.check.outputs.tag }} for OpenWrt ${{ matrix.branch }}

            -----
            Check the package architecture of your device using the command:
            ```
            # awk -F\' '/DISTRIB_ARCH/ {print $2}' /etc/openwrt_release
            ```
          files: ./**/*.ipk
